
<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>MapFish Print Module for IIS &#8212; Geographika</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css?v=9afac83c" />
    <link rel="stylesheet" type="text/css" href="../_static/font-awesome-4.7.0/css/font-awesome.min.css?v=02f538dc" />
    <link rel="stylesheet" type="text/css" href="../_static/mastodon-timeline.min.css?v=eddf9f32" />
    <link rel="stylesheet" type="text/css" href="../_static/custom-bootstrap-sphinx.css?v=459f6afa" />
    <script src="../_static/documentation_options.js?v=f2a433a1"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/ol.js?v=98716c8e"></script>
    <script src="../_static/mastodon-timeline.js?v=3ddbc6d4"></script>
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="MapInfo and SQL Server 2008" href="mapinfo-and-sql-server-2008.html" />
    <link rel="prev" title="Mapfish JavaScript Toolbox" href="mapfish-javascript-toolbox.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../_static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
<script type="text/javascript" src="../_static/bootstrap-3.4.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>

  </head><body>


  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          Geographika</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../software.html">Software</a></li>
                <li><a href="../presentations.html">Presentations</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../software.html">Software Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../presentations.html">Presentations</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../posts/index.html">Posts</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Archived Posts</a></li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="mapfish-javascript-toolbox.html" title="Previous Chapter: Mapfish JavaScript Toolbox"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Mapfish JavaS...</span>
    </a>
  </li>
  <li>
    <a href="mapinfo-and-sql-server-2008.html" title="Next Chapter: MapInfo and SQL Server 2008"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">MapInfo and S... &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">  
    <div class="body col-md-12 content" role="main">
      
  <section id="mapfish-print-module-for-iis">
<h1>MapFish Print Module for IIS<a class="headerlink" href="#mapfish-print-module-for-iis" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">date<span class="colon">:</span></dt>
<dd class="field-odd"><p>2010-11-10 16:42</p>
</dd>
<dt class="field-even">author<span class="colon">:</span></dt>
<dd class="field-even"><p>amercader</p>
</dd>
<dt class="field-odd">category<span class="colon">:</span></dt>
<dd class="field-odd"><p>mapfish, web development</p>
</dd>
<dt class="field-even">tags<span class="colon">:</span></dt>
<dd class="field-even"><p>printing java pylons github amercader</p>
</dd>
<dt class="field-odd">slug<span class="colon">:</span></dt>
<dd class="field-odd"><p>mapfish-print-module-for-iis</p>
</dd>
<dt class="field-even">status<span class="colon">:</span></dt>
<dd class="field-even"><p>published</p>
</dd>
</dl>
<p><a class="reference external" href="images/2010/11/image3.png"><img alt="image" src="../_images/image_thumb32.png" /></a> <em>This is a guest post by</em> <strong>`Adrià
Mercader &lt;http://amercader.net/&gt;`__</strong>.</p>
<p>Even in the current digital era, being able to print maps from
geospatial applications is still a very commonly requested feature.
Traditionally, there have been two main approaches to the map printing
on browser applications: handling it either on the client or on the
server. In the first case, a new page is opened with the suitable size
for a common paper format (e.g. A4 portrait) and is printed with the
browser’s print function. This is probably the easiest way to go if you
have a very basic map and you don’t need a complex layout, and big guys
like Google Maps do it this way. The second option is based on sending
all necessary information to a remote printing service, which will
produce an output file (generally a PDF) ready to be printed. This
allows for more complex layouts, different page sizes, etc. but with the
drawback of being more difficult to build and maintain.</p>
<p>Fortunately though, the <a class="reference external" href="http://mapfish.org">MapFish</a> mapping
framework includes a powerful <a class="reference external" href="http://mapfish.org/doc/print/">printing
module</a> that allows you to define
complex layouts and provides a protocol that can be integrated
seamlessly with <a class="reference external" href="http://www.geoext.org/">GeoExt</a> based applications.
The layouts can include legends, attribute tables, external images and
custom variables sent from the client, and are configured via files with
the YAML format. The MapFish site has a <a class="reference external" href="http://mapfish.org/doc/print/configuration.html">complete
reference</a> of the
configuration file syntax.</p>
<p>If you want to use the MapFish printing service out of the box, you need
to install it in a Java servlet container like Tomcat or use it as part
of the complete MapFish Python framework (See the <a class="reference external" href="http://mapfish.org/doc/print/installation.html">Installation
page</a> for full
details). But if you have an existing infrastructure, these two options
can seem like overkill. In our particular case, the printing service was
needed for an existing application served under IIS with
<a class="reference external" href="http://sourceforge.net/apps/trac/pyisapie">PyISAPIe</a>, so we had a
look on how to isolate the printing functionality from the rest of the
framework.</p>
<p>It turned out to be relatively easy: the actual work of generating the
PDF file with the provided spec is done by a <a class="reference external" href="http://en.wikipedia.org/wiki/JAR_%28file_format%29">JAR
file</a> (a
standalone Java application packaged into a single zip-like file).
Besides, there is a controller which handles the requests, calls the JAR
with the appropriate parameters and returns the response. This
<a class="reference external" href="http://trac.mapfish.org/trac/mapfish/browser/framework/server/trunk/mapfish/controllers/printer.py">controller
file</a>
is the key, and our work basically consisted of adapting the Paster and
Pylons specific code to PyISAPIe code. The same philosophy can be
adapted to any language or server: you will need a controller that gets
the requests, speaks with the JAR file and returns the output.</p>
<p>The code is Open Source and you can have a look at it on the GitHub
repository:</p>
<p><a class="reference external" href="https://github.com/amercader/MapFish-Print-IIS">https://github.com/amercader/MapFish-Print-IIS</a></p>
<p>The following are the steps you have to follow to get it up and running.
There aren’t any particularly complicated steps, but you have to be sure
to not miss anything.</p>
<section id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Link to this heading">¶</a></h2>
<ul>
<li><div><p>Python 2.5+</p>
</div></li>
<li><div><p>IIS 7.0 (Not tested under IIS 6.0)</p>
</div></li>
<li><div><p>PyISAPIe 1.1.0+</p>
</div></li>
<li><div><p>Java Runtime Environment 1.5+</p>
</div></li>
<li><div><p>MapFish print module JAR file</p>
</div></li>
</ul>
</section>
<section id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Link to this heading">¶</a></h2>
<ol class="arabic">
<li><p>Your server will need the <a class="reference external" href="http://www.java.com/en/download/index.jsp">Java Runtime
Environment</a> (which can
be a Windows x64 version). You may need to restart the machine to
update the environment variables (JAVA_HOME). If you plan to compile
the MapFish print module yourself, you will also need JDK 1.5+.</p></li>
<li><p>You will obviously need the MapFish print module JAR file. Compile it
following these
instructions:<a class="reference external" href="http://mapfish.org/doc/print/installation.html#compilation">http://mapfish.org/doc/print/installation.html#compilation</a>If
you don’t want or can’t compile it, you can use a pre-compiled one,
<a class="reference external" href="https://github.com/downloads/amercader/MapFish-Print-IIS/print-standalone-1.2.jar">available
here</a>,
but note that this may not be the most recent version of the print
module. Copy the JAR file in the directory of your choice.</p></li>
<li><p>Copy a YAML configuration file for the print service in the directory
of your choice and edit it as needed. You can find samples in the
‘samples’ directory of the MapFish print module source downloaded in
the previous point.</p></li>
<li><p>Install and configure PyISAPIe. You can follow the instructions
described on <a class="reference external" href="http://geographika.co.uk/setting-up-python-on-iis7">this
post</a> or in
the README file included with PyISAPIe . If you want to run a 64 bit
version, have a look at <a class="reference external" href="http://geographika.co.uk/compiling-a-64-bit-version-of-pyisapie">this
post</a>.</p></li>
<li><p>Download the <a class="reference external" href="https://github.com/amercader/MapFish-Print-IIS/zipball/master">latest
version</a>
of the package. Copy the files contained (Http and WWW modules and
the printer.ini file) where the PyISAPIe DLL can find them. The
easier choice is in the same folder as the DLL. You may want to move
Http and WWW, e.g to site-packages, but the printer.ini file must be
located in the DLL directory.</p></li>
<li><p>Edit printer.ini to define the configuration options:</p>
<ul>
<li><div><p>Path to the MapFish print module JAR file, compiled in the first
point.</p>
</div></li>
<li><div><p>Path to the YAML configuration file for the print service.</p>
</div></li>
<li><div><p>The temporary directory that will use the service to store the
generated files. Please note that the user running the application
on IIS must have full access to this directory (i.e. write and
delete files). If commented out in the printer.ini file, the
application will try to use the default OS temporary directory
(the one returned by <code class="docutils literal notranslate"><span class="pre">gettempdir()</span></code>)</p>
</div></li>
</ul>
</li>
<li><p>Create a virtual directory in IIS, and add the PyISAPIe DLL as a
<em>Wildcard Script Map</em>.<a class="reference external" href="images/2010/11/image3.png"><img alt="image" src="../_images/image_thumb32.png" /></a></p></li>
<li><p>Restart ISS and visit the following
URL:http://<em>your_server</em>/<em>virtual_dir</em>/info.jsonYou should
receive a JSON response with the capabilities of the printing
service.</p></li>
</ol>
<p><a class="reference external" href="images/2010/11/image3.png"><img alt="image" src="../_images/image_thumb32.png" /></a></p>
</section>
<section id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Link to this heading">¶</a></h2>
<ul>
<li><div class="line-block">
<div class="line"><strong>JAR file testing</strong></div>
<div class="line-block">
<div class="line">To test if that the JAR file works correctly, you can execute the</div>
</div>
</div>
<p>following command from the command line (replace the paths with your
own). You can find config.yaml and spec.json in the ‘samples’ folder
of the MapFish print module source:</p>
</p><p><code class="docutils literal notranslate"><span class="pre">java</span> <span class="pre">-jar</span> <span class="pre">C:/Python26/MapFish/print-standalone-1.2-SNAPSHOT.jar</span> <span class="pre">org.mapfish.print.ShellMapPrinter</span> <span class="pre">--config=&quot;C:/Python26/MapFish/config.yaml&quot;</span> <span class="pre">--spec=&quot;C:/Python26/MapFish/spec.json&quot;</span> <span class="pre">--output=&quot;C:/Python26/MapFish/tmp/test.pdf&quot;</span></code></p>
</li>
<li><p><strong>The service returns corrupted PDF files when printing the
OpenStreetMap layer</strong></p>
<blockquote>
<div><p>This is caused by a</p>
</div></blockquote>
<p><a class="reference external" href="http://trac.mapfish.org/trac/mapfish/ticket/605">bug</a> in the
MapFish source code. The availabe <a class="reference external" href="https://github.com/downloads/amercader/MapFish-Print-IIS/print-standalone-1.2.jar">pre-compiled JAR
file</a>
fixes this problem (Again, note that this may not be the most recent
version).</p>
</li>
<li><dl class="simple">
<dt><strong>IIS returns a 404 error when sending a print request</strong></dt><dd><p>If you are using the GET method to request the PDF file (i.e. using</p>
</dd>
</dl>
<p>the print.pdf end point), you may find that the server returns a 404
error if the query string is too long. That means that the query
string (the parameters sent after the service URL) is longer than the
IIS security limit. You could try to <a class="reference external" href="http://www.iis.net/ConfigReference/system.webServer/security/requestFiltering/requestLimits">adjust this
limit</a>,
but better yet, you can simply use POST requests from your client
application, which is the recommended setting. This way you won’t
have any problems regarding the length of the parameters sent.</p>
</li>
<li><dl class="simple">
<dt><strong>The application returns an exception when including a local image</strong></dt><dd><p>If you try to include a local image in your YAML configuration file,</p>
</dd>
</dl>
<p>(e.g. <code class="docutils literal notranslate"><span class="pre">url:</span> <span class="pre">'file://${configDir}/north.png'</span></code> or
<code class="docutils literal notranslate"><span class="pre">url:</span> <span class="pre">'${configDir}/north.png'</span></code>), the service will return an
exception. This is caused by a
<a class="reference external" href="http://trac.mapfish.org/trac/mapfish/ticket/606">bug</a>, and until
it’s fixed, a workaround is to use a file accessible via Http
(<code class="docutils literal notranslate"><span class="pre">url:</span> <span class="pre">'http://.../north.png'</span></code>).</p>
</li>
</ul>
</section>
<section id="feedback">
<h2>Feedback<a class="headerlink" href="#feedback" title="Link to this heading">¶</a></h2>
<p>I would love to hear about your experience using it, and if you think of
an enhancement or find a bug do not hesitate to contact me (<em>amercadero
at gmail.com</em> - <a class="reference external" href="http://amercader.net">http://amercader.net</a>) or even better, fork the code on
GitHub and contribute your changes.</p>
<dl class="field-list simple">
<dt class="field-odd">orphan<span class="colon">:</span></dt>
<dd class="field-odd"><p></p></dd>
</dl>
<hr><section id="comments">
<h3>Comments<a class="headerlink" href="#comments" title="Link to this heading">¶</a></h3>
<img alt="http://www.gravatar.com/avatar/ec399a4765f732e1a2acd5ca7edd0fd5?s=55&amp;d=identicon&amp;r=g" class="align-left" id="comment-431" src="http://www.gravatar.com/avatar/ec399a4765f732e1a2acd5ca7edd0fd5?s=55&amp;d=identicon&amp;r=g" />
<p><a class="reference internal" href="#comment-431"><span class="std std-ref">1.</span></a> <strong>geographika</strong>
**</p>
<p>I’ve since realised that the Firebug code is actually included in
OpenLayers see - <a class="reference external" href="http://openlayers.org/dev/examples/debug.html">http://openlayers.org/dev/examples/debug.html</a></p>
<a href="mailto:web+logging-openlayers-with-firebug#1@geographika.co.uk?Subject=logging-openlayers-with-firebug" target="_top">Reply</a><hr><img alt="http://www.gravatar.com/avatar/ec399a4765f732e1a2acd5ca7edd0fd5?s=55&amp;d=identicon&amp;r=g" class="align-left" id="comment-432" src="http://www.gravatar.com/avatar/ec399a4765f732e1a2acd5ca7edd0fd5?s=55&amp;d=identicon&amp;r=g" />
<p><a class="reference internal" href="#comment-432"><span class="std std-ref">2.</span></a> <strong>geographika</strong>
**</p>
<p>The OpenLayers blog also suggests a cross-browser alternative to FireBug
- <a class="reference external" href="http://openlayers.org/blog/2008/02/22/debugging-openlayers">http://openlayers.org/blog/2008/02/22/debugging-openlayers</a></p>
<a href="mailto:web+logging-openlayers-with-firebug#2@geographika.co.uk?Subject=logging-openlayers-with-firebug" target="_top">Reply</a><hr><a style="font-size: large; font-weight: bold;" href="mailto:web+mapfish-print-module-for-iis@geographika.co.uk?Subject=mapfish-print-module-for-iis" target="_top">Add Comment</a></section>
</section>
</section>


    </div>
      
  </div>
</div>
<script data-goatcounter="https://geographika.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>

<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2023.<br/>
    </p>
  </div>
</footer>

  </body>
</html>
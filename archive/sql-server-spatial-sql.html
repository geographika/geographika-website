
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>SQL Server Spatial SQL &#8212; Geographika</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom-bootstrap-sphinx.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/ol.js"></script>
    <script src="../_static/twitter.js"></script>
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Stack Overflow &amp; OSGeo" href="stack-overflow-osgeo.html" />
    <link rel="prev" title="Source Control using BitBucket" href="source-control-using-bitbucket.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../_static/js/jquery-1.12.4.min.js "></script>
<script type="text/javascript" src="../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../_static/bootstrap-3.4.1/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../_static/bootstrap-sphinx.js "></script>

  </head><body>


  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          Geographika</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Archived Posts</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#comments">Comments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../posts/nuget.html">Creating NuGet Packages</a></li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="source-control-using-bitbucket.html" title="Previous Chapter: Source Control using BitBucket"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Source Contro...</span>
    </a>
  </li>
  <li>
    <a href="stack-overflow-osgeo.html" title="Next Chapter: Stack Overflow & OSGeo"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Stack Overflo... &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">  
    <div class="body col-md-12 content" role="main">
      
  <section id="sql-server-spatial-sql">
<h1>SQL Server Spatial SQL</h1>
<dl class="field-list simple">
<dt class="field-odd">date</dt>
<dd class="field-odd"><p>2009-12-18 11:05</p>
</dd>
<dt class="field-even">author</dt>
<dd class="field-even"><p>admin</p>
</dd>
<dt class="field-odd">category</dt>
<dd class="field-odd"><p>geodatabases, sql server 2008</p>
</dd>
<dt class="field-even">slug</dt>
<dd class="field-even"><p>sql-server-spatial-sql</p>
</dd>
<dt class="field-odd">status</dt>
<dd class="field-odd"><p>published</p>
</dd>
</dl>
<p>I’ve been working more and more with the SQL Server 2008 spatial
queries. For standard queries I now rarely use the<a href="#id1"><span class="problematic" id="id2">|sql\_server\_2008|</span></a>
graphic design tools available in SQL Server Management Studio - SQL
scripts are far quicker, and easier to reuse. For spatial queries I
don’t think there even is a GUI. Anyway the following SQL snippets may
be of use to someone. I have only been using the GEOMETRY type, so these
may not be relevant to the GEOGRAPHY type, for a distinction see this
<a class="reference external" href="http://msdn.microsoft.com/en-us/library/bb964711.aspx">Microsoft
document</a>.</p>
<section id="geometry-and-projections">
<h2>Geometry and Projections</h2>
<p>Make <a class="reference external" href="http://msdn.microsoft.com/en-us/library/bb933835.aspx">valid
geometry</a> -
this can often fix ‘invisible’ datasets in desktop GIS packages such as
CadCorp.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">UPDATE</span> <span class="n">MyTable</span> <span class="n">SET</span> <span class="n">GeomFieldName</span> <span class="o">=</span> <span class="n">GeomFieldName</span><span class="o">.</span><span class="n">MakeValid</span><span class="p">()</span>
</pre></div>
</div>
<p>Set the <a class="reference external" href="http://www.spatialreference.org/">spatial reference</a> for all
features in a table
(<a class="reference external" href="http://msdn.microsoft.com/en-us/library/bb933851.aspx">STSrid</a>),
this is the equivalent of using a .prj file with a shapefile. You
<em>could</em> set a different reference for individual features, although why
you’d want to do that I’ve no idea. Note that this does not reproject
your data, but it is used to tell client applications what projection
the data is in. In <a class="reference external" href="http://mapserver.org/">MapServer</a> I found the
SRID has to be set correctly for
<a class="reference external" href="http://en.wikipedia.org/wiki/Web_Map_Service">WMS</a> layers to appear
in OpenLayers. Conversely in CadCorp’s
<a class="reference external" href="http://www.cadcorp.com/products_geographical_information_systems/geognosis.htm">GeognoSIS</a>I
had to set these values to 0 for data to display correctly. Change the
code according to the projection of your data.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">UPDATE</span> <span class="n">MyTable</span> <span class="n">SET</span> <span class="n">GeomFieldName</span><span class="o">.</span><span class="n">STSrid</span> <span class="o">=</span> <span class="mi">3785</span> <span class="o">--</span><span class="n">change</span> <span class="n">this</span> <span class="n">value</span> <span class="n">to</span> <span class="n">your</span> <span class="n">EPSG</span> <span class="n">code</span>
</pre></div>
</div>
</section>
<section id="feature-extents">
<h2>Feature Extents</h2>
<p>The next SQL code gets the extents of each feature, and saves them into
new fields. These fields are “calculated” so if the features are
modified then the extents will be updated, yet they are also saved to
disk rather than calculated dynamically for each query so they are as
fast to display as other fields.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">MyTable</span>
<span class="n">ADD</span> <span class="n">MinX</span> <span class="n">AS</span> <span class="p">(</span><span class="n">CONVERT</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">GeomFieldName</span><span class="o">.</span><span class="n">STEnvelope</span><span class="p">()</span><span class="o">.</span><span class="n">STPointN</span><span class="p">((</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">STX</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="n">PERSISTED</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">MyTable</span>
<span class="n">ADD</span> <span class="n">MinY</span> <span class="n">AS</span> <span class="p">(</span><span class="n">CONVERT</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">GeomFieldName</span><span class="o">.</span><span class="n">STEnvelope</span><span class="p">()</span><span class="o">.</span><span class="n">STPointN</span><span class="p">((</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">STY</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="n">PERSISTED</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">MyTable</span>
<span class="n">ADD</span> <span class="n">MaxX</span> <span class="n">AS</span> <span class="p">(</span><span class="n">CONVERT</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">GeomFieldName</span><span class="o">.</span><span class="n">STEnvelope</span><span class="p">()</span><span class="o">.</span><span class="n">STPointN</span><span class="p">((</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">STX</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="n">PERSISTED</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">MyTable</span>
<span class="n">ADD</span> <span class="n">MaxY</span> <span class="n">AS</span> <span class="p">(</span><span class="n">CONVERT</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">GeomFieldName</span><span class="o">.</span><span class="n">STEnvelope</span><span class="p">()</span><span class="o">.</span><span class="n">STPointN</span><span class="p">((</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">STY</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="n">PERSISTED</span>
</pre></div>
</div>
<p>Then to get the full extent of your data you can use (although there are
alternatives):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">Min</span><span class="p">(</span><span class="n">MinX</span><span class="p">)</span><span class="n">AS</span> <span class="n">MinX</span><span class="p">,</span> <span class="n">Min</span><span class="p">(</span><span class="n">MinY</span><span class="p">)</span> <span class="n">AS</span> <span class="n">MinY</span><span class="p">,</span>
<span class="n">MAX</span><span class="p">(</span><span class="n">MaxX</span><span class="p">)</span> <span class="n">AS</span> <span class="n">MaxX</span><span class="p">,</span> <span class="n">MAX</span><span class="p">(</span><span class="n">MaxY</span><span class="p">)</span> <span class="n">AS</span> <span class="n">MaxY</span>
<span class="n">FROM</span> <span class="n">MyTable</span>
</pre></div>
</div>
</section>
<section id="spatial-indexes">
<h2>Spatial Indexes</h2>
<p>As mentioned in a <a class="reference external" href="http://geographika.co.uk/?p=149">previous post</a>
spatial indexes can greatly improve display and query speeds. To create
an index in SQL use the following syntax. You should set the bounding
box to the extent of your data, which can be calculated using the query
above (and included in the SQL script).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE</span> <span class="n">SPATIAL</span> <span class="n">INDEX</span> <span class="n">MyIndexName</span> <span class="n">ON</span> <span class="n">MyTable</span><span class="p">(</span><span class="n">GeomFieldName</span><span class="p">)</span> <span class="n">USING</span>  <span class="n">GEOMETRY_GRID</span>
<span class="n">WITH</span> <span class="p">(</span>
<span class="n">BOUNDING_BOX</span> <span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1493907.5664457313</span><span class="p">,</span> <span class="mf">6128509.51667404</span><span class="p">,</span> <span class="o">-</span><span class="mf">578861.3521250226</span><span class="p">,</span> <span class="mf">7703103.135644257</span><span class="p">),</span>
<span class="n">GRIDS</span> <span class="o">=</span><span class="p">(</span><span class="n">LEVEL_1</span> <span class="o">=</span> <span class="n">MEDIUM</span><span class="p">,</span><span class="n">LEVEL_2</span> <span class="o">=</span> <span class="n">MEDIUM</span><span class="p">,</span><span class="n">LEVEL_3</span> <span class="o">=</span> <span class="n">MEDIUM</span><span class="p">,</span><span class="n">LEVEL_4</span> <span class="o">=</span> <span class="n">MEDIUM</span><span class="p">),</span>
<span class="n">CELLS_PER_OBJECT</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">PAD_INDEX</span>  <span class="o">=</span> <span class="n">OFF</span><span class="p">,</span> <span class="n">SORT_IN_TEMPDB</span> <span class="o">=</span> <span class="n">OFF</span><span class="p">,</span>
<span class="n">DROP_EXISTING</span> <span class="o">=</span> <span class="n">OFF</span><span class="p">,</span> <span class="n">ALLOW_ROW_LOCKS</span>  <span class="o">=</span> <span class="n">ON</span><span class="p">,</span> <span class="n">ALLOW_PAGE_LOCKS</span>  <span class="o">=</span> <span class="n">ON</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="spatial-queries">
<h2>Spatial Queries</h2>
<p>Sometimes SQL Server doesn’t seem to use spatial indexes automatically.
You can force a spatial query to use an index using the
WITH(INDEX(IndexName) statement similar to below which finds all
geometry in a table at a point specified by an X and Y (in a Web
Mercator projection -
<a class="reference external" href="http://www.spatialreference.org/ref/epsg/3785/">EPSG:3785</a>)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="o">*</span>
<span class="n">FROM</span> <span class="n">MyTable</span>
<span class="n">WITH</span> <span class="p">(</span><span class="n">INDEX</span> <span class="p">(</span><span class="n">MyIndexName</span><span class="p">))</span>
<span class="n">WHERE</span> <span class="p">(</span><span class="n">geometry</span><span class="p">::</span><span class="n">Point</span><span class="p">(</span><span class="nd">@x</span><span class="p">,</span><span class="nd">@y</span><span class="p">,</span><span class="mi">3785</span><span class="p">)</span><span class="o">.</span><span class="n">STWithin</span><span class="p">(</span><span class="n">MyGeomField</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>I have found that sometimes it is quicker when querying by points <em>not</em>
to use a spatial index, so it is worth experimenting.</p>
<p>To find all features within a user defined bounding box you can create a
stored procedure similar to the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE</span> <span class="n">PROCEDURE</span> <span class="p">[</span><span class="n">SearchByBounds</span><span class="p">]</span>
 <span class="nd">@minx</span> <span class="n">nvarchar</span><span class="p">(</span><span class="nb">max</span><span class="p">),</span>
 <span class="nd">@miny</span> <span class="n">nvarchar</span><span class="p">(</span><span class="nb">max</span><span class="p">),</span>
 <span class="nd">@maxx</span> <span class="n">nvarchar</span><span class="p">(</span><span class="nb">max</span><span class="p">),</span>
 <span class="nd">@maxy</span> <span class="n">nvarchar</span><span class="p">(</span><span class="nb">max</span><span class="p">)</span>
<span class="n">AS</span>
<span class="n">BEGIN</span>
 <span class="n">SET</span> <span class="n">NOCOUNT</span> <span class="n">ON</span><span class="p">;</span>
 <span class="n">declare</span> <span class="nd">@g</span> <span class="k">as</span> <span class="n">geometry</span><span class="p">;</span>
 <span class="n">declare</span> <span class="nd">@wkt</span> <span class="k">as</span> <span class="n">nvarchar</span><span class="p">(</span><span class="nb">max</span><span class="p">);</span>
 <span class="nb">set</span> <span class="nd">@wkt</span> <span class="o">=</span> <span class="s1">&#39;POLYGON ((&#39;</span> <span class="o">+</span> <span class="nd">@minx</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nd">@miny</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span>
 <span class="nd">@minx</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nd">@maxy</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nd">@maxx</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nd">@maxy</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nd">@maxx</span> <span class="o">+</span>
 <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nd">@miny</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nd">@minx</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nd">@miny</span> <span class="o">+</span> <span class="s1">&#39;))&#39;</span><span class="p">;</span>
 <span class="nb">set</span> <span class="nd">@g</span> <span class="o">=</span> <span class="n">geometry</span><span class="p">::</span><span class="n">STGeomFromText</span><span class="p">(</span><span class="nd">@wkt</span><span class="p">,</span> <span class="mi">3785</span><span class="p">);</span>
 <span class="o">--</span><span class="nb">print</span> <span class="nd">@wkt</span>
 <span class="n">SELECT</span> <span class="o">*</span>
 <span class="n">FROM</span> <span class="n">MyTable</span> <span class="n">WITH</span> <span class="p">(</span><span class="n">INDEX</span> <span class="p">(</span><span class="n">MySpatialIndex</span><span class="p">))</span>
 <span class="n">WHERE</span> <span class="n">GeomFieldName</span><span class="o">.</span><span class="n">STIntersects</span><span class="p">(</span><span class="nd">@g</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">END</span>
</pre></div>
</div>
<p>I haven’t found too many tutorials or blogs on the spatial features in
SQL Server 2008. The best resources I’ve found are:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://www.jasonfollas.com/blog/archive/2008/03/14/sql-server-2008-spatial-data-part-1.aspx">Jason Follas’s Introduction to SQL Server
Spatial</a></p></li>
<li><p><a class="reference external" href="http://blogs.msdn.com/isaac/archive/2009/05/28/sql-server-spatial-indexing.aspx">Issac’s posts on Spatial
Indexing</a></p></li>
<li><p><a class="reference external" href="http://www.sqlskills.com/blogs/Bobb/">Bob Beauchemin’s SQL Server Spatial
Blog</a></p></li>
<li><p>Alastair Aitchison’s book <a class="reference external" href="http://www.amazon.com/gp/product/1430218290?ie=UTF8&amp;tag=geographika-20&amp;linkCode=as2&amp;camp=1789&amp;creative=9325&amp;creativeASIN=1430218290">Beginning Spatial with SQL Server
2008</a><img alt="image1" src="http://www.assoc-amazon.com/e/ir?t=geographika-20&amp;l=as2&amp;o=1&amp;a=1430218290" /></p></li>
<li><p><a class="reference external" href="http://social.msdn.microsoft.com/Forums/en/sqlspatial/threads">MSDN’s SQL Server Spatial
Forums</a></p></li>
</ul>
<p>Feel free to post more links below.</p>
<dl class="field-list simple">
<dt class="field-odd">orphan</dt>
<dd class="field-odd"><p></p></dd>
</dl>
<hr><section id="comments">
<h3>Comments</h3>
<img alt="http://www.gravatar.com/avatar/?s=55&amp;d=identicon&amp;r=g" class="align-left" id="comment-436" src="http://www.gravatar.com/avatar/?s=55&amp;d=identicon&amp;r=g" />
<p><a class="reference internal" href="#comment-436"><span class="std std-ref">1.</span></a> <strong>geographika &amp;raquo; A 10 Minute Intro on using BitBucket with Windows</strong>
**</p>
<p>[…] There are already a couple of official quick start guides to using
Mercurial’s Window’s client program TortoiseHG, but below are the bare
details of how to use it with a new account on the BitBucket service.
[…]</p>
<a href="mailto:web+source-control-using-bitbucket#1@geographika.co.uk?Subject=source-control-using-bitbucket" target="_top">Reply</a><hr><a style="font-size: large; font-weight: bold;" href="mailto:web+sql-server-spatial-sql@geographika.co.uk?Subject=sql-server-spatial-sql" target="_top">Add Comment</a></section>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2022.<br/>
    </p>
  </div>
</footer>
  </body>
</html>